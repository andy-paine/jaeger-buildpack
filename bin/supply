#!/bin/bash
# bin/compile <build-dir> <cache-dir>

set -e

APP_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
IDX=$4

mkdir -p $DEPS_DIR/$IDX/bin
echo "Downloading Jaeger"
curl --progress-bar -L https://github.com/jaegertracing/jaeger/releases/download/v1.17.1/jaeger-1.17.1-linux-amd64.tar.gz -o jaeger.tgz
tar -xf jaeger.tgz --wildcards --strip 1 --directory $DEPS_DIR/$IDX/bin/ 'jaeger-*/jaeger-agent'

if [[ -n "${RUN_JAEGER_AGENT_AS_SIDECAR}" ]]; then
cat > $DEPS_DIR/$IDX/launch.yml <<EOF
processes:
- type: jaeger-agent
  command: jaeger-agent
  platforms:
    cloudfoundry:
      sidecar_for: [web]
EOF
fi

echo "-----> Done."
exit 0
