#!/bin/bash
# bin/compile <build-dir> <cache-dir>

set -e

APP_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
IDX=$4

mkdir -p $DEPS_DIR/$IDX/bin
if ! [ -f $CACHE_DIR/jaeger.tgz ]; then
  echo "Downloading Jaeger"
  curl --progress-bar -L https://github.com/jaegertracing/jaeger/releases/download/v1.17.1/jaeger-1.17.1-linux-amd64.tar.gz -o $CACHE_DIR/jaeger.tgz
  tar -xf $CACHE_DIR/jaeger.tgz --wildcards --strip 1 --directory $DEPS_DIR/$IDX/bin/ 'jaeger-*/jaeger-agent'
fi

cat > $DEPS_DIR/$IDX/launch.yml <<EOF
processes:
- type: jaeger-agent
  command: jaeger-agent
  platforms:
    cloudfoundry:
      sidecar_for: [web]
EOF

echo "-----> Done."
exit 0
